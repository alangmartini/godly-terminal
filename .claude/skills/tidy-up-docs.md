# Tidy Up Docs

Audit, organize, and distill the `docs/` investigation folder so it remains useful for future sessions.

## Usage

```
/tidy-up-docs
```

## Instructions

Run through all 4 phases below, in order. Report a summary at the end.

### Phase 1: Classify every doc

Read every file in `docs/`. For each one, determine its status:

| Status | Meaning | Criteria |
|--------|---------|----------|
| `RESOLVED` | Fix shipped and merged | PR merged, fix confirmed, no open threads |
| `ACTIVE` | Bug/issue still exists or fix is in progress | Unmerged PR, "remaining causes" section, partial fix |
| `REFERENCE` | Evergreen guide or architecture doc | How-to, profiling guide, testing procedure |
| `PLANNING` | Design doc for future work | Architecture plan not yet implemented |

**For each doc**, check whether it already has a `## Status:` line near the top. If not, add one immediately after the `# Title` heading:

```markdown
# My Investigation

**Status:** RESOLVED (PR #106, 2026-02-16)
```

If it already has a status line, update it if the status has changed (e.g., check git log to see if the associated PR has been merged since the doc was last updated).

### Phase 2: Build the index

Create or overwrite `docs/INDEX.md` with this format:

```markdown
# Docs Index

> Auto-generated by `/tidy-up-docs`. Do not edit manually.

## Active Issues
| File | Summary | Key Lesson |
|------|---------|------------|
| [terminal-freeze-investigation.md](terminal-freeze-investigation.md) | IPC pipeline cascade freeze | 12 attempts; remaining causes in Priority Matrix |

## Resolved Issues
| File | Summary | Key Lesson | Regression Risk |
|------|---------|------------|-----------------|
| [wmi-daemon-stderr-panic.md](wmi-daemon-stderr-panic.md) | Daemon hangs after FreeConsole | eprintln! panics without console; redirect stderr to NUL | Any new eprintln! in daemon after detach |

## Reference Docs
| File | Summary |
|------|---------|
| [memory-profiling.md](memory-profiling.md) | How to profile daemon/frontend/WebView memory |

## Planning Docs
| File | Summary | Implemented? |
|------|---------|-------------|
| [ultrafast-io-architecture.md](ultrafast-io-architecture.md) | Target <30ms output latency | Partially |
```

The "Key Lesson" column is the single most important takeaway — what a future session needs to know to avoid repeating mistakes.

The "Regression Risk" column describes what code change could reintroduce the bug.

### Phase 3: Distill into MEMORY.md

Open the project's auto-memory file at `~/.claude/projects/C--Users-alanm-Documents-dev-godly-claude-godly-terminal/memory/MEMORY.md`.

Add or update a `## Docs Lessons Learned` section with **one-liner takeaways** from resolved and active docs. Format:

```markdown
## Docs Lessons Learned
- Terminal freeze is a cascade across 5 pipeline layers, not a single bug (see docs/terminal-freeze-investigation.md)
- `eprintln!` panics after `FreeConsole()` — must redirect stderr to NUL (docs/wmi-daemon-stderr-panic.md)
- Ring buffer fallback data is never replayed to attached clients — backpressure can lose output (A1 in terminal-freeze)
- JSON serializes Vec<u8> as number array = 4x amplification on pipe (B1 in terminal-freeze, docs/architecture-review.md)
```

Rules for this section:
- Maximum 20 lines. Prioritize lessons that prevent repeating mistakes.
- Each line references the doc file for full context.
- Remove lessons for docs that have been deleted or are no longer relevant.
- Do NOT duplicate information that's already elsewhere in MEMORY.md — reference it or move it.

### Phase 4: Archive check

For each doc, evaluate whether it should be archived (moved to `docs/archive/`):

**Archive if ALL of these are true:**
- Status is `RESOLVED` or the planning doc's work is fully shipped
- The PR is merged to master
- The key lesson has been distilled into MEMORY.md (Phase 3)
- The doc contains no "Remaining Causes" or "TODO" sections with open items
- The doc is NOT referenced by CLAUDE.md (check for links)

**Do NOT archive if ANY of these are true:**
- The doc has a "Remaining Causes" or "Potential Issues" section with unresolved items
- The doc is explicitly linked from CLAUDE.md or other docs
- The issue has regression risk and the detailed investigation notes may be needed

When archiving:
1. Create `docs/archive/` if it doesn't exist
2. Move the file: `git mv docs/<file> docs/archive/<file>`
3. Update `docs/INDEX.md` to list it under a new `## Archived` section with a one-line summary

**Important:** Ask the user for confirmation before actually moving any files. Present the list of candidates and let them approve.

### Regression Detection

While reading each RESOLVED doc, check if any of the root causes or symptoms described could apply to currently open issues or recent bugs. Specifically:

1. Read recent git log (`git log --oneline -20`) for any recent fix/bug commits
2. For each resolved doc, check: could the same root cause have been reintroduced by recent changes?
3. If you find a potential regression, flag it prominently in the output:

```
POTENTIAL REGRESSION: [doc-name.md]
  Original issue: <symptom>
  Recent change that may reintroduce: <commit or file change>
  Suggestion: <what to check>
```

### Output

After all 4 phases, print a summary:

```
Docs Tidy-Up Complete
=====================
Files scanned:    16
Status updated:   8
Index entries:    16
MEMORY.md lines:  12 (of 20 max)
Archive candidates: 3 (awaiting approval)
Regressions found: 0
```
